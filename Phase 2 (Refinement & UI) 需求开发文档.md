# AtimeLog Clone - Phase 2 (Refinement & UI) 需求开发文档

版本: 2.2 (基于现有代码 + Gap 调整完成)

依赖基础: Phase 1 (Foundation - 数据读写层完成)

核心目标: 在已实现的 4 个主页面、JSON 本地存储、跨天切割、备份/恢复与暗黑模式的基础上，补齐记录内容的编辑体验、统计筛选能力、分类可配置度与群组化展示，并将 Gap 调整落实到现有实现。

更新依据:

- 当前代码基线（已实现）: Flutter 4 Tab（活动/分类/统计/更多）；开始/暂停(归档)/继续；最近活动；手动补录（同日）；时间线编辑起止时间与删除；饼图（今日/本周/本月/最近24小时/自定义）；分类管理（扩充图标/颜色+分组字段）；暗黑模式；备份/恢复；跨天自动切割；记录内容默认回退；时间线与饼图的群组合并/暂停合并/关键字搜索。
- P2 需求调整 (Gap Analysis): 统一“记录内容”命名；快速开始栏移除记录内容输入；记录内容默认值规则；活动/时间线编辑能力补充；分类颜色/图标扩展与群组化；统计页群组合并开关；时间线/饼图新增范围与搜索；暗黑模式纳入正式需求；最近24小时与自定义时间范围。

术语与默认值:

- “记录内容”= note = 备注，UI 文案统一使用“记录内容”。底层数据字段保持 note 兼容。
- 新建活动: 记录内容默认使用分类名称。
- 继续活动: 默认沿用该 groupId 上一次的记录内容。
- 手动补录/编辑: 若未填写记录内容，同样回退到分类名称。
- 快速开始栏不再出现记录内容输入，记录内容改在正在进行卡片或最近活动里修改。

---

## 1. 页面一：活动主页 (Home / Activity)

### 1.0 规则与默认

- 记录内容仅在“正在进行”卡片、最近活动列表、时间线编辑中修改；快速开始栏只选择分类并触发开始。
- 最近活动列表的条目代表一个 groupId 的最近片段，保留累计时长与记录内容，支持直接编辑/继续。

### 1.1 界面布局 (UI Layout)

1. **顶部：活动看板**
   - **正在进行 (Active):** 显示图标、分类名、记录内容（可编辑并保存）、动态计时。操作: [暂停(归档&入最近)]、[停止(归档但不入最近/移除)]、[修改开始时间]。
   - **最近活动 (Recent Contexts):** 展示 current_session.recentContexts。显示: 图标、分类名、记录内容、累计时长、最后活跃时间。操作: [继续]、[编辑记录内容/起止时间（同日）]、[移除]。
2. **快速开始栏:** 仅包含分类选择 + “开始”按钮；不出现记录内容输入，启动时记录内容遵循默认规则。
3. **底部：分类网格:** 展示全部启用分类。点击=切换/新建计时（新 groupId），长按=手动补录入口。

### 1.2 交互逻辑 (Interaction Logic)

- **开始/切换:** 允许在有进行中任务时切换分类；创建新 groupId；记录内容默认分类名或沿用用户输入（若在活动卡片/最近项已修改）。
- **暂停(归档):** 结算当前片段写入日档，推入最近活动列表，清空 current。
- **停止:** 结算当前片段写入日档，但不推入最近活动列表（或从最近移除）。
- **继续:** 从最近活动读取 groupId/categoryId/记录内容，复用 groupId 开始计时。
- **编辑开始时间:** 允许对正在进行的活动修改 startTime（已实现）。
- **编辑记录内容:** 在正在进行卡片和最近活动条目中提供编辑入口，更新 current 或 recentContexts 中的记录内容（保存后落盘）。
- **编辑最近活动起止时间:** 通过最近活动入口编辑最近片段（同日内）或跳转时间线编辑；不支持跨日片段直接修改，需拆分。
- **手动补录:** 仍限制同一天；分类选择、记录内容默认分类名、开始/结束时间必填，保存后进入归档并推入最近活动。

---

## 2. 页面二：统计与图表 (Statistics)

全局开关:

- **群组合并开关:** 可切换“按群组.子类合并”为群组汇总或按子类独立展示，影响时间线与饼图。

### 2.1 时间线 (Timeline List)

- **数据源:** `data/YYYYMM/YYYY-MM-DD.json`；支持范围查询（单日/最近24小时/自定义起止），跨日范围按时间交集筛选。
- **展示字段:** 起始时间、结束时间、时长、记录内容；可附带分类/群组信息。
- **时间范围模式:**
  - 最近24小时。
  - 指定日期（单日），支持前一天/后一天快捷切换。
  - 自定义模式：起始时间+终止时间（可跨日）+ 关键字搜索（记录内容/分类名/群组名模糊匹配）。
- **暂停合并开关:** 切换“合并同 groupId 的片段”为一条汇总（展示总起止时间和碎片列表）或按时间顺序逐片段展开。
- **群组合并开关:** 切换“群组.子类”按群组汇总或按子类独立展示。
- **编辑:** 点击记录/汇总项可修改 startTime、endTime、记录内容，或删除片段。保存后提醒时间重叠风险；当前编辑限制同日片段，跨日需拆分。

### 2.2 饼图界面 (Pie Chart)

- **维度:** 按 categoryId 汇总时长；在群组合并模式下，可按群组聚合。
- **范围选项:** 今日 / 本周 / 本月 / 最近24小时 / 自定义起止时间段（按时间交集统计）。
- **交互:** 点击扇区显示时长、百分比；显示所选范围的日期区间；群组合并开关与时间线保持一致。

### 2.3 高级统计 (可选/P3)

- 柱状图（每日时长趋势），与群组合并开关保持一致。

---

## 3. 页面三：分类管理 (Categories)

- **列表展示:** 支持拖拽排序 (`order`)、启用/停用开关。
- **新建/编辑:**
  - 名称、群组（支持“群组.子类”活动命名，例: 睡眠.午睡；群组本身也可作为可选计时项）。
  - 图标选择: 扩充可选图标池（> 20 个，覆盖工作/学习/出行/生活等）。
  - 颜色选择: 扩充颜色池，采用“主色 + 多阶梯度”方案，便于区分同一色系下的子类。
  - 启用状态。
- **删除/停用:** 优先软删除/停用，避免历史数据失联。

---

## 4. 页面四：更多与设置 (Settings)

- **主题:** 亮色/暗色模式（现已实现，纳入正式需求描述）。
- **备份与恢复:** 导出/导入 `/atimelog_data` 压缩包。
- **关于:** 版本号展示。

---

## 5. 后端逻辑补充 (Technical Refinement for P2)

- **午夜切断:** 保持现有实现：跨天时自动在 23:59:59 归档片段，00:00:00 继续，同 groupId。
- **数据修正:** 保持 `updateRecord(date, recordId, newStart, newEnd, note)` API；允许重叠但需 UI 提示。记录内容字段沿用 note。
- **范围/搜索支持:** 时间线支持起止时间过滤与记录内容/分类名/群组关键字过滤；已提供跨日范围加载。
- **聚合策略:** 支持两种模式——按片段展示（不合并暂停）与按 groupId 聚合展示（合并暂停）；群组合并开关对统计与饼图聚合生效。
- **默认记录内容回退:** 后端写入时若 note 为空，回退到分类名称，保持与 UI 规则一致。
- **编辑限制:** 时间线与最近活动的时间编辑限定同日片段，跨日需拆分。

---

## 6. 开发优先级 (Priority Checklist)

1. [x] **基础框架与主题:** 4 Tab 导航、暗黑模式、备份/恢复。
2. [x] **活动页记录内容与快速开始调整:** 快速开始栏移除记录内容输入；默认记录内容规则；正在进行/最近活动支持记录内容编辑。
3. [x] **活动时间编辑补强:** 最近活动条目支持同日起止时间编辑或跳转时间线编辑。
4. [x] **分类管理扩展:** 图标池、颜色池扩容；群组.子类命名与选择；排序/启用保持。
5. [x] **统计时间线增强:** 最近24小时/自定义范围/关键字搜索；暂停合并开关；群组合并开关。
6. [x] **饼图增强:** 新增最近24小时与自定义范围；与群组合并开关联动。
7. [x] **跨天与数据修正基础:** 午夜切断、记录编辑 API 已有，需在新 UI 中复用提示。
