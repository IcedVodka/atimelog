## å¢åŠ åŠŸèƒ½

å¢åŠ webdavåŒæ­¥åŠŸèƒ½
å¢åŠ ä¸€ä¸ªatimelog_dataä¸‹çš„localæ–‡ä»¶å¤¹æ”¹åä¸ºcurrentã€‚
åœ¨æ ¹ç›®å½•å¢åŠ ä¸€ä¸ªä»…æœ¬åœ°ä½¿ç”¨è¿›è¡Œä¸åŒæ­¥çš„etagæ–‡ä»¶å¤¹å­˜å‚¨etagã€‚
etagæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ªcurrent_etag.jsonè®°å½•currentæ–‡ä»¶å¤¹çš„äº‘ç«¯etagï¼Œè¿˜æœ‰etagdataæ–‡ä»¶å¤¹ï¼ŒæŒ‰åˆ†æ–‡ä»¶å¤¹ï¼ˆæŒ‰æœˆä»½ï¼‰å­˜å‚¨å¯¹åº”çš„å½’æ¡£æ•°æ®æ–‡ä»¶çš„etagæ•°æ®ï¼Œæ¯”å¦‚202512_etag.jsonè®°å½•202512æ–‡ä»¶å¤¹ä¸‹çš„etagæ•°æ®ã€‚

æ›´å¤šç•Œé¢çš„åŒæ­¥å¸ƒå±€å¯ä»¥å‚è€ƒè¿™ä¸ª
![alt text](image.png)
å¯ä»¥è®¾ç½®webdavæœåŠ¡å™¨çš„å­˜å‚¨è·¯å¾„ï¼Œå¯ä»¥éªŒè¯æœåŠ¡å™¨éªŒè¯ä¸æ£€æŸ¥åŒæ­¥ä»…æ˜¯å¦èƒ½è¿åŒæœåŠ¡å™¨ï¼Œæœ‰æ‰‹åŠ¨åŒæ­¥æŒ‰é’®è®©ç”¨æˆ·è¿›è¡Œæ‰‹åŠ¨åŒæ­¥ï¼Œå¯ä»¥è®¾ç½®å¤šå°‘åˆ†é’Ÿè¿›è¡ŒåŒæ­¥ä¸€æ¬¡ã€‚
å¹³æ—¶ä¸»è¦åœ¨æ´»åŠ¨é¡µé¢ï¼Œæ‰€ä»¥åœ¨åœ¨æ´»åŠ¨é¡µé¢å¢åŠ ä¸€ä¸ªå°åŒºåŸŸæ˜¾ç¤ºåŒæ­¥ä¿¡æ¯å’Œä¸€ä¸ªæ‰‹åŠ¨åŒæ­¥æŒ‰é’®ã€‚å¯åŠ¨å’Œé€€å‡ºçš„æ—¶å€™è‡ªåŠ¨è¿›è¡Œä¸€æ¬¡åŒæ­¥ã€‚


ä¸‹é¢æ˜¯å‚è€ƒé€»è¾‘ï¼Œåº”è¯¥åªè¯´äº†dataæ–‡ä»¶å¤¹åŒæ­¥ï¼Œcurrentæ–‡ä»¶å¤¹ä¹Ÿè¦åŒæ­¥ï¼Œä½ å®Œå–„ä¸€ä¸‹é€»è¾‘ç„¶åå®ç°ã€‚


### ä¸€ã€ æ¨¡å—æ‹†è§£ (Module Breakdown)

æˆ‘ä»¬å°†ç³»ç»Ÿä¾ç„¶åˆ†ä¸ºä¸‰å±‚ï¼Œä½†é‡ç‚¹å¢å¼ºäº†**ç›®å½•ç®¡ç†**çš„èƒ½åŠ›ã€‚

#### 1. ç½‘ç»œå±‚ (Network / WebDAV Layer)

_åªè´Ÿè´£â€œæ‰§è¡Œå‘½ä»¤â€ï¼Œä¸è´Ÿè´£â€œæ€è€ƒâ€ã€‚æ‰€æœ‰è·¯å¾„å‡ä¸ºç›¸å¯¹è·¯å¾„æˆ–å®Œæ•´ URLã€‚_

- **`list_remote_subdirectories(root_path)`**
    
    - **åŠŸèƒ½**ï¼šåˆ—å‡ºäº‘ç«¯Â `data/`Â ä¸‹æ‰€æœ‰çš„æœˆä»½æ–‡ä»¶å¤¹ã€‚
        
    - **é€»è¾‘**ï¼š`PROPFIND (Depth: 1)`Â -> ç­›é€‰å‡ºÂ `resourcetype`Â ä¸ºÂ `collection`Â çš„é¡¹ç›® -> è¿”å›åˆ—è¡¨Â `["202511", "202512", ...]`ã€‚
        
- **`fetch_folder_file_list(month_path)`**
    
    - **åŠŸèƒ½**ï¼šè·å–æŒ‡å®šæœˆä»½æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰æ–‡ä»¶çš„ ETagã€‚
        
    - **é€»è¾‘**ï¼š`PROPFIND (Depth: 1)`Â -> ç­›é€‰å‡ºéæ–‡ä»¶å¤¹çš„Â `json`Â æ–‡ä»¶ -> è¿”å› MapÂ `{ "2025-12-05.json": "etag_123", ... }`ã€‚
        
- **`download_file(file_path)`**
    
    - **åŠŸèƒ½**ï¼šä¸‹è½½æ–‡ä»¶ã€‚
        
    - **è¾“å‡º**ï¼šè¿”å›å¯¹è±¡Â `{ content: String, etag: String }`ã€‚
        
    - **æ³¨æ„**ï¼šè¿™é‡Œè¿”å› ETag æ˜¯ä¸ºäº†ç¡®ä¿ä¸‹è½½çš„é‚£ä¸€ç¬é—´æ–‡ä»¶çš„æŒ‡çº¹ï¼Œé˜²æ­¢å¹¶å‘åå·®ã€‚
        
- **`upload_file(file_path, content)`**
    
    - **åŠŸèƒ½**ï¼šä¸Šä¼ æ–‡ä»¶ã€‚
        
    - **è¾“å‡º**ï¼šè¿”å›Â `new_etag`Â (String)ã€‚
        
    - **å…³é”®**ï¼šWebDAV çš„Â `PUT`Â å“åº”å¤´ï¼ˆHeadersï¼‰é‡Œé€šå¸¸åŒ…å«Â `ETag`ï¼Œç›´æ¥è§£æå¹¶è¿”å›å®ƒã€‚
        

#### 2. æœ¬åœ°å±‚ (Local / IO Layer)

_è´Ÿè´£ç£ç›˜è¯»å†™å’Œç»´æŠ¤â€œå…ƒæ•°æ®è´¦æœ¬â€ã€‚_

- **`get_local_month_folders()`**
    
    - **åŠŸèƒ½**ï¼šæ‰«ææœ¬åœ°Â `data/`Â ç›®å½•ï¼Œè¿”å›å­˜åœ¨çš„æœˆä»½æ–‡ä»¶å¤¹åˆ—è¡¨Â `["202511", "202512"]`ã€‚
        
- **`get_local_files_in_month(month)`**
    
    - **åŠŸèƒ½**ï¼šè¿”å›è¯¥æ–‡ä»¶å¤¹ä¸‹å®é™…å­˜åœ¨çš„ JSON æ–‡ä»¶ååˆ—è¡¨ã€‚
        
- **`read_local_file_timestamp(relative_path)`**
    
    - **åŠŸèƒ½**ï¼šè¯»å–æ–‡ä»¶å†…å®¹ï¼Œè§£æÂ `lastUpdated`Â å­—æ®µå¹¶è¿”å›ã€‚
        
- **`update_sync_meta(relative_path, new_etag)`**
    
    - **åŠŸèƒ½**ï¼šæ›´æ–°æœ¬åœ°çš„Â `sync_meta.json`ã€‚
        
    - **é€»è¾‘**ï¼šæ¨è Key ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œå¦‚Â `"202512/2025-12-05.json": "etag_value"`ï¼Œè¿™æ ·å…¨å±€å”¯ä¸€ã€‚
        
- **`get_cached_etag(relative_path)`**
    
    - **åŠŸèƒ½**ï¼šä»Â `sync_meta.json`Â è¯»å–ç¼“å­˜çš„ ETagã€‚
        

#### 3. ä¸šåŠ¡é€»è¾‘å±‚ (Sync Orchestrator)

_è´Ÿè´£æŒ‡æŒ¥ã€‚æ ¸å¿ƒå˜åŒ–åœ¨äºå¢åŠ äº†â€œå¤–å±‚å¾ªç¯â€ã€‚_

---

### äºŒã€ æ ¸å¿ƒåŒæ­¥é€»è¾‘æµç¨‹

æˆ‘ä»¬å°†é€»è¾‘åˆ†ä¸ºÂ **3 ä¸ªåŸå­æ“ä½œ**Â å’ŒÂ **1 ä¸ªä¸»å¾ªç¯**ã€‚

#### ğŸ’¡ åŸå­æ“ä½œ Aï¼š`action_download_overwrite(path)`

_å½“å†³å®šâ€œäº‘ç«¯è¦†ç›–æœ¬åœ°â€æ—¶è°ƒç”¨ã€‚_

1. **ç½‘è·¯**ï¼šè°ƒç”¨Â `download_file(path)`ï¼Œæ‹¿åˆ°Â `content`Â å’ŒÂ `remote_etag`ã€‚
    
2. **æœ¬åœ°**ï¼šå†™å…¥Â `content`Â åˆ°ç£ç›˜ã€‚
    
3. **æœ¬åœ°**ï¼šè°ƒç”¨Â `update_sync_meta(path, remote_etag)`ã€‚**ï¼ˆç›´æ¥å†™å…¥ï¼Œä¸æŸ¥è¯¢ï¼‰**
    
4. **ç»“æŸ**ã€‚
    

#### ğŸ’¡ åŸå­æ“ä½œ Bï¼š`action_upload_overwrite(path)`

_å½“å†³å®šâ€œæœ¬åœ°è¦†ç›–äº‘ç«¯â€æˆ–â€œä¸Šä¼ æ–°æ–‡ä»¶â€æ—¶è°ƒç”¨ã€‚_

1. **æœ¬åœ°**ï¼šè¯»å–æ–‡ä»¶Â `content`ã€‚
    
2. **ç½‘ç»œ**ï¼šè°ƒç”¨Â `upload_file(path, content)`ã€‚
    
    - _WebDAV å“åº”ä¼šè¿”å›æ–°çš„ ETagã€‚_
        
3. **æœ¬åœ°**ï¼šæ‹¿åˆ°è¿”å›çš„ ETagï¼Œè°ƒç”¨Â `update_sync_meta(path, new_etag)`ã€‚**ï¼ˆç›´æ¥å†™å…¥ï¼Œä¸æŸ¥è¯¢ï¼‰**
    
4. **ç»“æŸ**ã€‚
    

#### ğŸ’¡ åŸå­æ“ä½œ Cï¼š`action_resolve_conflict(path, remote_etag)`

_å½“æœ¬åœ°æœ‰æ–‡ä»¶ä½† ETag ä¸ä¸€è‡´æ—¶è°ƒç”¨ã€‚_

1. **ç½‘ç»œ**ï¼š`download_file(path)`Â -> æ‹¿åˆ°Â `cloud_content`ã€‚
    
2. **è§£æ**ï¼š
    
    - `cloud_ts`Â = è§£æÂ `cloud_content`Â çš„Â `lastUpdated`ã€‚
        
    - `local_ts`Â = è°ƒç”¨æœ¬åœ°å±‚Â `read_local_file_timestamp`ã€‚
        
3. **è£åˆ¤**ï¼š
    
    - **Cloud > Local (äº‘ç«¯æ–°)**ï¼šæ‰§è¡ŒÂ **åŸå­æ“ä½œ A**ã€‚
        
    - **Local > Cloud (æœ¬åœ°æ–°)**ï¼šæ‰§è¡ŒÂ **åŸå­æ“ä½œ B**ã€‚
        
    - **Equal (ç›¸ç­‰)**ï¼šè¯´æ˜å†…å®¹å…¶å®ä¸€æ ·ï¼Œä»…æ›´æ–°æœ¬åœ° metaï¼š`update_sync_meta(path, remote_etag)`ã€‚
        

---

### ä¸‰ã€ å®Œæ•´åŒæ­¥ä¸»æµç¨‹ (Master Routine)

è¿™æ˜¯ä½ æ¯æ¬¡ç‚¹å‡»â€œåŒæ­¥â€æŒ‰é’®æ—¶è¿è¡Œçš„é€»è¾‘ï¼š

**æ­¥éª¤ 1ï¼šæ„å»ºæœˆä»½é›†åˆ (Discovery)**

- `remote_months`Â = ç½‘ç»œå±‚.`list_remote_subdirectories()`
    
- `local_months`Â = æœ¬åœ°å±‚.`get_local_month_folders()`
    
- `all_months`Â =Â `remote_months`Â å’ŒÂ `local_months`Â çš„å¹¶é›† (Set Union)ã€‚
    
    - _ç›®çš„ï¼šé˜²æ­¢æ¼æ‰â€œäº‘ç«¯æœ‰ä½†æœ¬åœ°æ²¡æœ‰çš„æœˆä»½â€æˆ–è€…â€œæœ¬åœ°æ–°å»ºä½†äº‘ç«¯æ²¡æœ‰çš„æœˆä»½â€ã€‚_
        

**æ­¥éª¤ 2ï¼šéå†æœˆä»½ (Outer Loop)**

- **FOR EACH**Â `month`Â **IN**Â `all_months`:
    
    - **2.1 å‡†å¤‡æ•°æ®**
        
        - `remote_files_map`Â = ç½‘ç»œå±‚.`fetch_folder_file_list(month)`Â (è·å–è¯¥æœˆæ‰€æœ‰äº‘ç«¯æ–‡ä»¶åå’ŒETag)
            
        - `local_files_list`Â = æœ¬åœ°å±‚.`get_local_files_in_month(month)`Â (è·å–è¯¥æœˆæ‰€æœ‰æœ¬åœ°æ–‡ä»¶å)
            
        - `path_prefix`Â =Â `month + "/"`Â (ä¾‹å¦‚ "202512/")
            
    - **2.2 éå†äº‘ç«¯åˆ—è¡¨ (å¤„ç† ä¸‹è½½ & å†²çª)**
        
        - **FOR EACH**Â `filename, cloud_etag`Â **IN**Â `remote_files_map`:
            
            - `full_path`Â =Â `path_prefix + filename`
                
            - `cached_etag`Â = æœ¬åœ°å±‚.`get_cached_etag(full_path)`
                
            - **IF**Â (æœ¬åœ°æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶):
                
                - æ‰§è¡ŒÂ **åŸå­æ“ä½œ A (ä¸‹è½½)**ã€‚
                    
            - **ELSE IF**Â (`cached_etag`Â !=Â `cloud_etag`):
                
                - æ‰§è¡ŒÂ **åŸå­æ“ä½œ C (å†²çªè§£å†³)**ã€‚
                    
            - **ELSE**:
                
                - ETag ä¸€è‡´ï¼Œè·³è¿‡ã€‚
                    
    - **2.3 éå†æœ¬åœ°åˆ—è¡¨ (å¤„ç† çº¯ä¸Šä¼ )**
        
        - **FOR EACH**Â `filename`Â **IN**Â `local_files_list`:
            
            - **IF**Â (è¯¥æ–‡ä»¶å ä¸åœ¨Â `remote_files_map`Â ä¸­):
                
                - `full_path`Â =Â `path_prefix + filename`
                    
                - æ‰§è¡ŒÂ **åŸå­æ“ä½œ B (ä¸Šä¼ )**ã€‚
                    

**æ­¥éª¤ 3ï¼šæ”¶å°¾**

- å°†å†…å­˜ä¸­æ›´æ–°è¿‡çš„Â `sync_meta`Â æŒä¹…åŒ–ä¿å­˜åˆ° json æ–‡ä»¶ã€‚
    
- UI æç¤ºâ€œåŒæ­¥å®Œæˆâ€ã€‚
